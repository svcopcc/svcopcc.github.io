<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼µå§”å“¡æŠ½çæ©Ÿå™¨äºº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #1e293b;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            max-width: 800px;
            width: 100%;
            margin: 1rem;
        }
        .title {
            color: #0c4a6e;
            font-size: 2.25rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1rem;
        }
        .subtitle {
            text-align: center;
            color: #475569;
            margin-bottom: 2rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #334155;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #0c4a6e;
            box-shadow: 0 0 0 3px rgba(12, 74, 110, 0.2);
        }
        button {
            width: 100%;
            padding: 1rem;
            background-color: #0e7490;
            color: white;
            font-weight: 700;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            cursor: pointer;
            text-transform: uppercase;
        }
        button:hover {
            background-color: #0f76a6;
        }
        .results {
            margin-top: 2rem;
        }
        .results-section {
            background-color: #f8fafc;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid #e2e8f0;
        }
        .results-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
        }
        ul {
            list-style: none;
            padding: 0;
        }
        li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #e2e8f0;
        }
        li:last-child {
            border-bottom: none;
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #22c55e;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            opacity: 0;
            visibility: hidden;
        }
        .message-box.show {
            transform: translate(-50%, 0);
            opacity: 1;
            visibility: visible;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 90%;
            max-width: 400px;
        }
        .modal-content button {
            margin-top: 1rem;
            width: 80%;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

<div class="container mx-auto p-8 bg-white rounded-xl shadow-lg">
    <h1 class="text-3xl font-bold text-center text-sky-800 mb-2">å¼µå§”å“¡å…¬å¹³æŠ½çæ©Ÿ</h1>
    <p class="text-center text-gray-600 mb-8">æŠ½çé–‹å§‹ã€‚</p>
    <p style="color: rgb(255 134 44);text-align: right;font-size=1.5em;font-size: 1.2em;"><a href="https://feixu.tw/BBD/">ğŸ”—ğŸ”—å›é¦–é </p>

    <div class="form-group">
        <label for="eventName" class="block text-gray-700 font-semibold mb-2">æ´»å‹•åç¨±ï¼š</label>
        <input type="text" id="eventName" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-sky-800" placeholder="ä¾‹å¦‚ï¼šå¤æ—¥æ„Ÿæ©å›é¥‹æŠ½ç">
    </div>

    <div class="form-group">
        <label for="prizes" class="block text-gray-700 font-semibold mb-2">çé …åç¨±*æ•¸é‡ <br> (æ¯è¡Œä¸€å€‹ï¼Œä¾‹å¦‚ï¼šç‰¹ç*1, æ™®ç*5)ï¼š</label>
        <textarea id="prizes" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-sky-800" placeholder="ä¾‹å¦‚ï¼š
ç‰¹ç*1
é ­ç*2
æ™®ç*10"></textarea>
    </div>

    <div class="form-group">
        <label for="participants" class="block text-gray-700 font-semibold mb-2">æ‰€æœ‰åƒèˆ‡è€…åå–® (æ¯è¡Œä¸€å€‹å§“å)ï¼š
        <br><a href="https://feixu.tw/open/name-creation.html" target="_blank">â‡’ é€£çµï¼šå§“åç”¢ç”Ÿå™¨</a></label>
        <textarea id="participants" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-sky-800" placeholder="ä¾‹å¦‚ï¼š
ç‹å°æ˜
æå°è¯
é™³å¤§åŒ"></textarea>
    </div>

    <div class="flex flex-col space-y-4">
        <button id="startBtn" onclick="startLottery()" class="bg-cyan-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-cyan-700 transition duration-300">
            é–‹å§‹æŠ½ç
        </button>
        <button id="reDrawBtn" onclick="reDraw()" class="hidden bg-gray-500 text-white font-bold py-3 rounded-lg shadow-md hover:bg-gray-600 transition duration-300">
            æœªæ›´æ–°å…§å®¹å†æ¬¡æŠ½ç
        </button>
    </div>
    
    <div id="results" class="results hidden">
        <h2 class="text-2xl font-bold text-center mt-8 text-sky-800">æŠ½ççµæœ</h2>
        <p class="text-center text-gray-600 mt-2">
            ç¸½åƒèˆ‡äººæ•¸ï¼š<span id="totalParticipantsCount"></span> äºº
            <br>
            æŠ½çæ™‚é–“ï¼š<span id="drawTime"></span>
        </p>
        
        <div id="winnersSection" class="results-section hidden">
            <h3 class="text-lg font-semibold text-gray-800">å¾—çè€…åå–®</h3>
            <div id="prizesResults"></div>
        </div>

        <div id="losersSection" class="results-section hidden">
            <h3 class="text-lg font-semibold text-gray-800">æœªå¾—çè€…åå–® (<span id="losersCount"></span> äºº)</h3>
            <ul id="losersList"></ul>
        </div>

        <div class="mt-8 flex justify-center">
            <button onclick="showExportModal()" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                åŒ¯å‡ºæŠ½ççµæœ
            </button>
        </div>
    </div>
</div>

<div id="messageBox" class="message-box"></div>

<!-- Export Modal -->
<div id="exportModal" class="modal-overlay">
    <div class="modal-content">
        <h4 class="text-xl font-bold text-gray-800 mb-4">è«‹é¸æ“‡åŒ¯å‡ºæ ¼å¼</h4>
        <button onclick="exportAsText()" class="bg-gray-500 hover:bg-gray-600">ç´”æ–‡å­— (.txt)</button>
        <button onclick="exportAsCsv()" class="bg-green-600 hover:bg-green-700">CSV (.csv)</button>
        <button onclick="exportAsJson()" class="bg-blue-600 hover:bg-blue-700">JSON (.json)</button>
        <button onclick="closeExportModal()" class="bg-red-500 hover:bg-red-600">å–æ¶ˆ</button>
    </div>
</div>

<script>
    let currentWinnersData = [];
    let currentLosersData = [];
    let currentTotalParticipants = 0;
    let currentDrawTime = '';
    let currentEventName = '';
    let drawCount = 0;
    
    // Store the last valid inputs to check for changes
    let lastInputs = { eventName: '', prizes: '', participants: '' };

    const startBtn = document.getElementById('startBtn');
    const reDrawBtn = document.getElementById('reDrawBtn');
    const eventNameInput = document.getElementById('eventName');
    const prizesInput = document.getElementById('prizes');
    const participantsInput = document.getElementById('participants');

    function showMessage(message, isSuccess = true) {
        const messageBox = document.getElementById('messageBox');
        messageBox.textContent = message;
        messageBox.style.backgroundColor = isSuccess ? '#22c55e' : '#ef4444';
        messageBox.classList.add('show');
        setTimeout(() => {
            messageBox.classList.remove('show');
        }, 3000);
    }

    function showExportModal() {
        if (currentWinnersData.length === 0 && currentLosersData.length === 0) {
            showMessage('ç›®å‰æ²’æœ‰æŠ½ççµæœå¯ä¾›åŒ¯å‡ºã€‚', false);
            return;
        }
        document.getElementById('exportModal').style.display = 'flex';
    }

    function closeExportModal() {
        document.getElementById('exportModal').style.display = 'none';
    }

    function resetDrawState() {
        drawCount = 0;
        startBtn.classList.remove('hidden');
        reDrawBtn.classList.add('hidden');
        reDrawBtn.textContent = 'æœªæ›´æ–°å…§å®¹å†æ¬¡æŠ½ç';
    }

    // Attach event listeners to reset state on input change
    eventNameInput.addEventListener('input', resetDrawState);
    prizesInput.addEventListener('input', resetDrawState);
    participantsInput.addEventListener('input', resetDrawState);

    function startLottery() {
        if (drawCount > 0) {
            showMessage('è«‹ä½¿ç”¨ã€Œæœªæ›´æ–°å…§å®¹å†æ¬¡æŠ½çã€æŒ‰éˆ•é‡æ–°æŠ½çã€‚', false);
            return;
        }

        const eventName = eventNameInput.value.trim();
        const prizesText = prizesInput.value.trim();
        const participantsText = participantsInput.value.trim();

        if (!eventName || !prizesText || !participantsText) {
            showMessage('è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼', false);
            return;
        }

        lastInputs = { eventName, prizes: prizesText, participants: participantsText };
        drawCount = 1;
        performDrawLogic(eventName, prizesText, participantsText, drawCount);
        
        startBtn.classList.add('hidden');
        reDrawBtn.classList.remove('hidden');
        reDrawBtn.textContent = 'æœªæ›´æ–°å…§å®¹å†æ¬¡æŠ½ç (ç¬¬ 2 æ¬¡)';
    }

    function reDraw() {
        if (drawCount === 0) {
            showMessage('è«‹å…ˆé€²è¡Œé¦–æ¬¡æŠ½çã€‚', false);
            return;
        }
        
        // Use the last valid inputs for re-draw
        drawCount++;
        performDrawLogic(lastInputs.eventName, lastInputs.prizes, lastInputs.participants, drawCount);
        reDrawBtn.textContent = `æœªæ›´æ–°å…§å®¹å†æ¬¡æŠ½ç (ç¬¬ ${drawCount + 1} æ¬¡)`;
    }

    function performDrawLogic(eventName, prizesText, participantsText, currentDrawCount) {
        const prizes = prizesText.split('\n').filter(p => p).map(p => {
            const parts = p.split('*');
            return {
                name: parts[0].trim(),
                count: parseInt(parts[1].trim(), 10) || 0
            };
        });

        const totalPrizes = prizes.reduce((sum, prize) => sum + prize.count, 0);
        const allParticipants = participantsText.split('\n').filter(p => p.trim() !== '');

        const uniqueParticipants = [...new Set(allParticipants)];
        if (allParticipants.length !== uniqueParticipants.length) {
            showMessage('åƒèˆ‡è€…åå–®ä¸­å­˜åœ¨é‡è¤‡å§“åï¼Œå·²ç‚ºæ‚¨è‡ªå‹•å»é‡ã€‚');
        }
        
        if (totalPrizes === 0) {
            showMessage('çé …æ•¸é‡æœªè¼¸å…¥ï¼Œæˆ–æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ï¼', false);
            resetDrawState();
            return;
        }

        if (totalPrizes > uniqueParticipants.length) {
            showMessage('çé …ç¸½æ•¸ï¼ˆ' + totalPrizes + 'ï¼‰è¶…éåƒèˆ‡è€…äººæ•¸ï¼ˆ' + uniqueParticipants.length + 'ï¼‰ï¼Œè«‹é‡æ–°è¨­å®šã€‚', false);
            resetDrawState();
            return;
        }

        currentTotalParticipants = uniqueParticipants.length;
        currentEventName = eventName;
        
        const shuffledParticipants = [...uniqueParticipants];
        for (let i = shuffledParticipants.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffledParticipants[i], shuffledParticipants[j]] = [shuffledParticipants[j], shuffledParticipants[i]];
        }

        const winners = shuffledParticipants.slice(0, totalPrizes);
        const losers = shuffledParticipants.slice(totalPrizes);

        const winnerSet = new Set(winners);
        if (winnerSet.size !== winners.length) {
            console.error('å¾—çè€…åå–®ä¸­ç™¼ç¾é‡è¤‡ï¼Œè«‹æª¢æŸ¥æ¼”ç®—æ³•ã€‚');
            showMessage('æŠ½çå‡ºéŒ¯ï¼Œè«‹é‡è©¦ã€‚', false);
            return;
        }

        if (winners.length + losers.length !== currentTotalParticipants) {
            console.error('å¾—çè€…èˆ‡æœªå¾—çè€…äººæ•¸ç¸½å’Œä¸ç­‰æ–¼åƒèˆ‡äººæ•¸ã€‚');
            showMessage('æŠ½çå‡ºéŒ¯ï¼Œè«‹é‡è©¦ã€‚', false);
            return;
        }

        // Prepare data for export
        currentWinnersData = [];
        let winnerIndex = 0;
        prizes.forEach(prize => {
            for (let i = 0; i < prize.count; i++) {
                if (winners[winnerIndex]) {
                    currentWinnersData.push({ prize: prize.name, winner: winners[winnerIndex] });
                    winnerIndex++;
                }
            }
        });
        currentLosersData = losers;

        displayResults(prizes, winners, losers, currentTotalParticipants, currentDrawCount);
    }

    function displayResults(prizes, winners, losers, totalParticipantsCount, currentDrawCount) {
        document.getElementById('totalParticipantsCount').textContent = totalParticipantsCount;
        
        const now = new Date();
        const formattedDate = `${now.getFullYear()}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')}`;
        const formattedTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
        currentDrawTime = `${formattedDate} ${formattedTime}`;
        document.getElementById('drawTime').textContent = currentDrawTime;

        const prizesResultsDiv = document.getElementById('prizesResults');
        prizesResultsDiv.innerHTML = '';
        
        let winnerIndex = 0;
        prizes.forEach(prize => {
            const prizeContainer = document.createElement('div');
            prizeContainer.className = 'my-4 p-4 bg-gray-50 rounded-lg border border-gray-200';
            
            const prizeTitle = document.createElement('h4');
            prizeTitle.textContent = `${prize.name} (${prize.count} å)`;
            prizeTitle.className = 'font-bold text-gray-800 text-lg mb-2';
            
            const winnersListForPrize = document.createElement('ul');
            winnersListForPrize.className = 'list-disc list-inside';
            
            for (let i = 0; i < prize.count; i++) {
                const winnerName = winners[winnerIndex];
                if (winnerName) {
                    const li = document.createElement('li');
                    li.textContent = winnerName;
                    li.className = 'font-medium text-gray-700';
                    winnersListForPrize.appendChild(li);
                    winnerIndex++;
                }
            }
            
            prizeContainer.appendChild(prizeTitle);
            prizeContainer.appendChild(winnersListForPrize);
            prizesResultsDiv.appendChild(prizeContainer);
        });

        const losersList = document.getElementById('losersList');
        losersList.innerHTML = '';
        losers.forEach(loser => {
            const li = document.createElement('li');
            li.textContent = loser;
            li.className = 'text-gray-500';
            losersList.appendChild(li);
        });
        
        document.getElementById('losersCount').textContent = losers.length;

        document.getElementById('results').classList.remove('hidden');
        document.getElementById('winnersSection').classList.remove('hidden');
        document.getElementById('losersSection').classList.remove('hidden');
        
        const message = currentDrawCount > 1 ? `ç¬¬ ${currentDrawCount} æ¬¡æŠ½çå®Œæˆï¼` : 'æŠ½çå®Œæˆï¼';
        showMessage(message);
    }

    function downloadFile(filename, content, mimeType) {
        const element = document.createElement('a');
        const blob = new Blob([content], { type: mimeType });
        element.href = URL.createObjectURL(blob);
        element.download = filename;
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }

    function exportAsCsv() {
        if (currentWinnersData.length === 0 && currentLosersData.length === 0) {
            showMessage('ç›®å‰æ²’æœ‰æŠ½ççµæœå¯ä¾›åŒ¯å‡ºã€‚', false);
            closeExportModal();
            return;
        }
        
        let csvContent = `æŠ½çæ´»å‹•,${currentEventName}\n`;
        csvContent += `æŠ½çæ™‚é–“,${currentDrawTime}\n`;
        csvContent += `æŠ½çæ¬¡æ•¸,${drawCount}\n\n`;
        csvContent += `ç¸½åƒèˆ‡äººæ•¸,${currentTotalParticipants}\n`;
        csvContent += `å¾—çäººæ•¸,${currentWinnersData.length}\n`;
        csvContent += `æœªå¾—çäººæ•¸,${currentLosersData.length}\n\n`;
        csvContent += "ç‹€æ…‹,çé …åç¨±,å§“å\n";

        currentWinnersData.forEach(item => {
            csvContent += `å¾—ç,"${item.prize}","${item.winner}"\n`;
        });
        currentLosersData.forEach(loser => {
            csvContent += `æœªå¾—ç,,"${loser}"\n`;
        });
        
        const filename = `${currentEventName}_å®Œæ•´æŠ½ççµæœ.csv`;
        downloadFile(filename, csvContent, 'text/csv;charset=utf-8;');
        showMessage('CSV æª”æ¡ˆå·²åŒ¯å‡ºï¼');
        closeExportModal();
    }

    function exportAsJson() {
        if (currentWinnersData.length === 0 && currentLosersData.length === 0) {
            showMessage('ç›®å‰æ²’æœ‰æŠ½ççµæœå¯ä¾›åŒ¯å‡ºã€‚', false);
            closeExportModal();
            return;
        }

        const jsonContent = JSON.stringify({
            eventName: currentEventName,
            drawTime: currentDrawTime,
            drawCount: drawCount,
            totalParticipants: currentTotalParticipants,
            totalWinners: currentWinnersData.length,
            totalLosers: currentLosersData.length,
            winners: currentWinnersData,
            losers: currentLosersData
        }, null, 2);

        const filename = `${currentEventName}_å®Œæ•´æŠ½ççµæœ.json`;
        downloadFile(filename, jsonContent, 'application/json;charset=utf-8;');
        showMessage('JSON æª”æ¡ˆå·²åŒ¯å‡ºï¼');
        closeExportModal();
    }

    function exportAsText() {
        if (currentWinnersData.length === 0 && currentLosersData.length === 0) {
            showMessage('ç›®å‰æ²’æœ‰æŠ½ççµæœå¯ä¾›åŒ¯å‡ºã€‚', false);
            closeExportModal();
            return;
        }

        let textContent = `æŠ½çæ´»å‹•ï¼š${currentEventName}\n`;
        textContent += `æŠ½çæ™‚é–“ï¼š${currentDrawTime}\n`;
        textContent += `æŠ½çæ¬¡æ•¸ï¼š${drawCount}\n\n`;
        textContent += `--- çµ±è¨ˆ --- \n`;
        textContent += `ç¸½åƒèˆ‡äººæ•¸ï¼š${currentTotalParticipants} äºº\n`;
        textContent += `å¾—çäººæ•¸ï¼š${currentWinnersData.length} äºº\n`;
        textContent += `æœªå¾—çäººæ•¸ï¼š${currentLosersData.length} äºº\n\n`;

        const prizesMap = {};
        currentWinnersData.forEach(item => {
            if (!prizesMap[item.prize]) {
                prizesMap[item.prize] = [];
            }
            prizesMap[item.prize].push(item.winner);
        });

        textContent += `--- å¾—çè€…åå–® ---\n`;
        for (const prize in prizesMap) {
            textContent += `  ${prize} (${prizesMap[prize].length} å)\n`;
            prizesMap[prize].forEach(winner => {
                textContent += `    - ${winner}\n`;
            });
        }
        textContent += `\n--- æœªå¾—çè€…åå–® ---\n`;
        currentLosersData.forEach(loser => {
            textContent += `${loser}\n`;
        });

        const filename = `${currentEventName}_å®Œæ•´æŠ½ççµæœ.txt`;
        downloadFile(filename, textContent, 'text/plain;charset=utf-8;');
        showMessage('ç´”æ–‡å­—æª”æ¡ˆå·²åŒ¯å‡ºï¼');
        closeExportModal();
    }
</script>
</body>
</html>
